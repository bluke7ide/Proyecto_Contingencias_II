---
title: "Proyecto - Contingencias de Vida II"
author: 
  - Luis Fernando Amey Apuy - C20470
  - Javier Hernández Navarro - C13674
  - Anthony Mauricio Jiménez Navarro - C24067
  - Gustavo Alberto Amador Fonseca - C20459
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    self_contained: true
    highlight: tango
---
# Librerías e importaciones
```{r, warning=FALSE, message=FALSE}
source("cod/setup.R")
source("cod/load_database.R")
source("cod/prob_estim.R")
```

# Factor de degradación para estados CAR
La metodología original empezaba a dar problemas con probabilidades negativas a partir de una edad aproximada de 95 años, por lo que se decidió implementar un factor de reducción desde los 90 años para primero, complementar la probabilidad creciente de muerte y además poder arreglar el problema de probabilidades negativas.
```{r, echo = FALSE, message=FALSE, warning=FALSE}
degradacion <- data.frame(
  x = 90:120, 
  hombres = sapply(90:120, function(x) red_factor_norm(x, 1)),
  mujeres = sapply(90:120, function(x) red_factor_norm(x, 2))
  )


fig <- ggplot(degradacion, aes(x = x)) +
  geom_point(aes(y = hombres, color = "Hombres")) +
  geom_point(aes(y = mujeres, color = "Mujeres")) +
  theme_minimal() +
  labs(
    title = "Factor de reducción de deterioro para edades 90:120",
    x = "Edad",
    y = "Factor de reducción",
    colour = " "
  ) +
  scale_color_manual(values = c("Hombres" = "navyblue",
                                "Mujeres" = "violetred")) 
fig %>% ggplotly()
```

# Empezar las tablas
```{r}
source("cod/tablas.R")
Males <- tablas(1)
Females <- tablas(2)
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
fig <- ggplot(Males$Able, aes(x = x)) +
  geom_line(aes(y = Able, color = "Able")) +
  geom_line(aes(y = Mild, color = "Mild")) +
  geom_line(aes(y = Moderate, color = "Moderate")) +
  geom_line(aes(y = Severe, color = "Severe")) +
  geom_line(aes(y = Profound, color = "Profound")) +
  geom_line(aes(y = Dead, color = "Dead")) +
  theme_minimal() +
  labs(
    title = "Probabilidades de transición para hombres en estado Able",
    x = "Edad",
    y = "Valor"
  ) +
  scale_color_manual(values = c(
    "Able" = "green",
    "Mild" = "navyblue",
    "Moderate" = "magenta",
    "Severe" = "yellow",
    "Profound" = "cyan",
    "Dead" = "purple"
  ))

fig %>% ggplotly()
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
fig <- ggplot(Females$Able, aes(x = x)) +
  geom_line(aes(y = Able, color = "Able")) +
  geom_line(aes(y = Mild, color = "Mild")) +
  geom_line(aes(y = Moderate, color = "Moderate")) +
  geom_line(aes(y = Severe, color = "Severe")) +
  geom_line(aes(y = Profound, color = "Profound")) +
  geom_line(aes(y = Dead, color = "Dead")) +
  theme_minimal() +
  labs(
    title = "Probabilidades de transición para mujeres en estado Able",
    x = "Edad",
    y = "Valor"
  ) +
  scale_color_manual(values = c(
    "Able" = "green",
    "Mild" = "navyblue",
    "Moderate" = "magenta",
    "Severe" = "yellow",
    "Profound" = "cyan",
    "Dead" = "purple"
  ))

fig %>% ggplotly()
```

# Mejora de mortalidades en el tiempo y mejora de transiciones de empeoramiento

```{r}
source("cod/degradar_mort.R")
```

```{r}
edad20 <- degradar_mort(20, 1)
```

# Diseño del producto
Pago de primas: anual
Esto se justifica con las probabilidades de transición de un año
Temporalidad del seguro: vitalicio
Es un seguro LTC, por lo que esperamos a que el asegurado tenga varios estados
antes de morir. Si no fuera vitalicio, dejaríamos a medias a un asegurado.

Inflación: 3%
  Caso pesimista: 8%
  Caso optimista: -1%
  
Tasa de interés: 5%
  Caso pesimista: 3%
  Caso optimista: 6.5%


```{r}
calculo_acumulado <- function(x, tables){
  # Por si acaso, estados termina en 000001 porque multiplicamos todas las transiciones
  t1 <- tables$Able %>% select(-x) 
  t2 <- tables$Mild %>% select(-x) 
  t3 <- tables$Moderate %>% select(-x)
  t4 <- tables$Severe %>% select(-x)
  t5 <- tables$Profound %>% select(-x)
  estados <- as.numeric(t1[1,])
  suma <- estados
  for(i in 2:(120-x)){
    matriz_t <- rbind(t1[i,], t2[i,], t3[i,], t4[i,], t5[i,], c(0,0,0,0,0,1)) 
    matriz_t <- as.matrix(matriz_t)
    estados <- estados %*% matriz_t
    suma <- suma + estados
  }
  return(suma)
}
```

```{r}
calculo_acumulado(20, edad20)
```

```{r}
edad20sin_m <- lapply(Males, function(x) as.data.frame(x[21:120,]))
calculo_acumulado(20, edad20sin_m)
```
Hay una clara diferencia entre mejorías de mortalidades

```{r}
rm(
  add_mort,
  deteriorate,
  degradacion,
  prob,
  readdata,
  red_factor_norm,
  tablas,
  fig,
  edad20sin_m
)
```

# Cálculo de valores presentes
```{r}
calculo_vp <- function(x, tables, interes, inflacion){
  # Por si acaso, termina en 000001 porque estamos multiplicando todas las transiciones
  v <- (1+inflacion)/(1+interes)
  t1 <- tables$Able %>% select(-x)
  t2 <- tables$Mild %>% select(-x) 
  t3 <- tables$Moderate %>% select(-x)
  t4 <- tables$Severe %>% select(-x)
  t5 <- tables$Profound %>% select(-x)
  estados <- as.numeric(t1[1,])
  suma <- estados
  seguro <- 0
  for(i in 2:(120-x)){
    matriz_t <- rbind(t1[i,], t2[i,], t3[i,], t4[i,], t5[i,], c(0,0,0,0,0,1)) 
    matriz_t <- as.matrix(matriz_t)
    temp <- estados %*% matriz_t
    
    # Personalizable según el tipo de desembolso/prima
    seguro <- seguro  + (temp[6]- estados[6])*v^i
    estados <- temp
    suma <- suma + estados*v^(i-1)
  }
  suma[6] <- seguro
  return(suma)
}
```

```{r}
prueba <- calculo_vp(20, edad20, 0.07, 0.03)

# Seguro de vida normal, 100 millones
(prueba[6]*100e6 )/(12*prueba[1])

# Seguro de vida con anualidades en caso de Severe o Profound, pagando Mild y Moderate
(prueba[6]*100e6 + 12*(1.5e6*prueba[4] + 3e6*prueba[5])  )/(12*(prueba[1]+prueba[2]+prueba[3]))

# Seguro de vida con anualidades pagando 0.25e6 en aumento de estado
(prueba[6]*100e6 + 12*(0.25e6*prueba[2] +
                         0.5e6*prueba[3] +
                         0.75e6*prueba[4] +
                         1e6*prueba[5]))/(12*prueba[1])

# Seguro de vida con anualidades pagando 0.5e6 en aumento de estado
(prueba[6]*100e6 + 12*(0.5e6*prueba[2] +
                         1e6*prueba[3] +
                         1.5e6*prueba[4] +
                         2e6*prueba[5]))/(12*prueba[1])

```
# Cálculo de las primas 
```{r}
primas_h <- sapply(20:70, function(x) calculo_vp(x, degradar_mort(x, 1), 0.05, 0.03))
primas_m <- sapply(20:70, function(x) calculo_vp(x, degradar_mort(x, 2), 0.07, 0.03))
```

```{r}
rm(
  edad20, 
  prueba,
  calculo_acumulado,
  calculo_vp
)
```

# Portafolio
## Generación del portafolio
```{r}
set.seed(70707)
portfolio <- data.frame(edad = round(rnorm(5000, mean = 45, sd = 6.5)),
                         sexo = round(runif(5000, 1, 2))) %>% 
  arrange(., edad, sexo) %>%
  mutate(id = dense_rank(paste(edad, sexo)))
descripcion <- portfolio %>% count(edad, sexo)
```

```{r}
lista <- list()
for(i in 1:length(descripcion$edad)) {
  prob_matrices <- degradar_mort(descripcion$edad[i], descripcion$sexo[i])
  
  # Aplicar `cumsum` a cada dataframe dentro de `prob_matrices` (uno por estado)
  lista[[i]] <- lapply(prob_matrices, function(df) {
    t(apply(df[, 2:7], 1, cumsum))
  })
}
```

## Prima nivelada
```{r}
primas_p <- sapply(1:length(descripcion$edad),
                   function(x) calculo_vp(descripcion$edad[x],
                                          degradar_mort(descripcion$edad[x],
                                                        descripcion$sexo[x]),
                                          0.05, 0.03) )
```
  
```{r}
source("cod/prima.R")
prima(primas_h[,26])
nivelada <- primas_p %*% descripcion$n
(nivelada <- prima(nivelada))
```

```{r}
rm(
  degradar_mort,
  red_factor_mort,
  red_factor_rest
)
```

# Modelo estocástico
## Proyección de primas
Esto es extra, no se piden. 
```{r}
source("cod/proy_prima.R")
```

```{r}
t <- proc.time()
proy_prima_data <- proy_prima_par(100, 0.07, 0.03)
raw <- proy_prima_data
proc.time()-t
```

```{r}
proy_prima_data <- list()
for(i in 1:100){
  proy_prima_data[[i]] <- raw[,,i]
}
proy_prima_data <- sapply(proy_prima_data, function(x) descripcion$n %*% x)
```


## Preparación para modelar estocásticamente
### Variables globales
```{r}
interes <- 0.07
inflacion <- 0.03
edades <- portfolio$edad
rango <- 120 - min(edades)
v <- (1 + inflacion) / (1 + interes)
v_power <- v^(0:rango)
mujeres <- sum(portfolio$sexo == 2)
hombres <- sum(portfolio$sexo == 1)
sexos <- portfolio$sexo == 1
variables <- c("lista",
                "portfolio",
                "sexos",
                "hombres",
                "mujeres",
                "rango",
                "v_power",
                "proyeccion") 
```

### Funciones 
```{r}
source("cod/proyecciones.R")
```

## Proyeccion grupal de pagos y vivos
### Única
```{r}
set.seed(1)
t <- proc.time()
prueba <- proyeccion()
proc.time()-t
```

### Varias
```{r}
set.seed(1)
t <- proc.time()
prueba_gr <- list()
for(i in 1:10){
  prueba_gr[[i]] <- proyeccion()
}
proc.time()-t
```

### Paralelizado
```{r}
t <- proc.time()
proyeccion_data <- proyeccion_par(100, cores = 2)
proc.time()-t
```
# Resumen estocástico
## Esperanza 
```{r}
source("cod/resumen_estoc.R")
```

```{r}
t <- proc.time()
media <- esperanza(proyeccion_data)
proc.time()-t
```

## Percentil
```{r}
t <- proc.time()
percent.995 <- perc_0_995(proyeccion_data)
proc.time()-t
```

## Guardar las proyecciones
```{r}
write_xlsx(media, "res/media.xlsx")
write_xlsx(percent.995, "res/percentil.xlsx")
```

## Leer las proyecciones
```{r}
media <- list(
  read_xlsx("res/media.xlsx", sheet = 1),
  read_xlsx("res/media.xlsx", sheet = 2),
  read_xlsx("res/media.xlsx", sheet = 3),
  read_xlsx("res/media.xlsx", sheet = 4)
)
percent.995 <- list(
  read_xlsx("res/percentil.xlsx", sheet = 1),
  read_xlsx("res/percentil.xlsx", sheet = 2),
  read_xlsx("res/percentil.xlsx", sheet = 3),
  read_xlsx("res/percentil.xlsx", sheet = 4)
)
```


```{r}
sum(percent.995[[3]][[1]])
sum(percent.995[[3]][[2]])

sum(percent.995[[4]][[1]])
sum(percent.995[[4]][[2]])
```

## Gráficos
```{r, echo = FALSE, message=FALSE, warning=FALSE}
fig <- ggplot(media[[1]], aes(x = x)) +
  geom_line(aes(y = Able, color = "Able")) +
  geom_line(aes(y = Mild, color = "Mild")) +
  geom_line(aes(y = Moderate, color = "Moderate")) +
  geom_line(aes(y = Severe, color = "Severe")) +
  geom_line(aes(y = Profound, color = "Profound")) +
  geom_line(aes(y = Dead, color = "Dead")) +
  theme_minimal() +
  labs(
    title = "Media de hombres en cada estado",
    x = "Edad",
    y = "Valor"
  ) +
  scale_color_manual(values = c(
    "Able" = "green",
    "Mild" = "navyblue",
    "Moderate" = "magenta",
    "Severe" = "yellow",
    "Profound" = "cyan",
    "Dead" = "purple"
  ))

fig %>% ggplotly()
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
fig <- ggplot(media[[2]], aes(x = x)) +
  geom_line(aes(y = Able, color = "Able")) +
  geom_line(aes(y = Mild, color = "Mild")) +
  geom_line(aes(y = Moderate, color = "Moderate")) +
  geom_line(aes(y = Severe, color = "Severe")) +
  geom_line(aes(y = Profound, color = "Profound")) +
  geom_line(aes(y = Dead, color = "Dead")) +
  theme_minimal() +
  labs(
    title = "Media de mujeres en cada estado",
    x = "Edad",
    y = "Valor"
  ) +
  scale_color_manual(values = c(
    "Able" = "green",
    "Mild" = "navyblue",
    "Moderate" = "magenta",
    "Severe" = "yellow",
    "Profound" = "cyan",
    "Dead" = "purple"
  ))

fig %>% ggplotly()
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
fig <- ggplot(percent.995[[1]], aes(x = x)) +
  geom_line(aes(y = Able, color = "Able")) +
  geom_line(aes(y = Mild, color = "Mild")) +
  geom_line(aes(y = Moderate, color = "Moderate")) +
  geom_line(aes(y = Severe, color = "Severe")) +
  geom_line(aes(y = Profound, color = "Profound")) +
  geom_line(aes(y = Dead, color = "Dead")) +
  theme_minimal() +
  labs(
    title = "Percentil 99.5 de Hombres en cada estado",
    x = "Edad",
    y = "Valor"
  ) +
  scale_color_manual(values = c(
    "Able" = "green",
    "Mild" = "navyblue",
    "Moderate" = "magenta",
    "Severe" = "yellow",
    "Profound" = "cyan",
    "Dead" = "purple"
  ))

fig %>% ggplotly()
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
fig <- ggplot(percent.995[[2]], aes(x = x)) +
  geom_line(aes(y = Able, color = "Able")) +
  geom_line(aes(y = Mild, color = "Mild")) +
  geom_line(aes(y = Moderate, color = "Moderate")) +
  geom_line(aes(y = Severe, color = "Severe")) +
  geom_line(aes(y = Profound, color = "Profound")) +
  geom_line(aes(y = Dead, color = "Dead")) +
  theme_minimal() +
  labs(
    title = "Percentil 99.5 de mujeres en cada estado",
    x = "Edad",
    y = "Valor"
  ) +
  scale_color_manual(values = c(
    "Able" = "green",
    "Mild" = "navyblue",
    "Moderate" = "magenta",
    "Severe" = "yellow",
    "Profound" = "cyan",
    "Dead" = "purple"
  ))

fig %>% ggplotly()
```

## Ingresos y egresos
```{r}
sum(media[[3]][[1]])
sum(media[[3]][[2]])

sum(media[[4]][[1]])
sum(media[[4]][[2]])
```

```{r}
sum(percent.995[[3]][[1]])
sum(percent.995[[3]][[2]])

sum(percent.995[[4]][[1]])
sum(percent.995[[4]][[2]])
```




















