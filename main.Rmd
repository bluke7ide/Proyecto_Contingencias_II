---
title: "Proyecto - Contingencias de Vida II"
author: 
  - Luis Fernando Amey Apuy - C20470
  - Javier Hernández Navarro - C13674
  - Anthony Mauricio Jiménez Navarro - C24067
  - Gustavo Alberto Amador Fonseca - C20459
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    self_contained: true
    highlight: tango
---
# Librerías e importaciones
```{r, warning=FALSE, message=FALSE}
source("cod/setup.R")
source("cod/load_database.R")
source("cod/prob_estim.R")
```

# Factor de degradación para estados CAR
La metodología original empezaba a dar problemas con probabilidades negativas a partir de una edad aproximada de 95 años, por lo que se decidió implementar un factor de reducción desde los 90 años para primero, complementar la probabilidad creciente de muerte y además poder arreglar el problema de probabilidades negativas.
```{r, echo = FALSE, message=FALSE, warning=FALSE}
degradacion <- data.frame(
  x = 90:120, 
  hombres = sapply(90:120, function(x) red_factor_norm(x, 1)),
  mujeres = sapply(90:120, function(x) red_factor_norm(x, 2))
  )


fig <- ggplot(degradacion, aes(x = x)) +
  geom_point(aes(y = hombres, color = "Hombres")) +
  geom_point(aes(y = mujeres, color = "Mujeres")) +
  theme_minimal() +
  labs(
    title = "Factor de reducción de deterioro para edades 90:120",
    x = "Edad",
    y = "Factor de reducción",
    colour = " "
  ) +
  scale_color_manual(values = c("Hombres" = "navyblue",
                                "Mujeres" = "violetred")) 
fig %>% ggplotly()
```

# Empezar las tablas
```{r}
source("cod/tablas.R")
Males <- tablas(1)
Females <- tablas(2)
```

```{r, echo = FALSE, message=FALSE, warning=FALSE}
fig <- ggplot(Males$Able, aes(x = x)) +
  geom_line(aes(y = Able, color = "Able")) +
  geom_line(aes(y = Mild, color = "Mild")) +
  geom_line(aes(y = Moderate, color = "Moderate")) +
  geom_line(aes(y = Severe, color = "Severe")) +
  geom_line(aes(y = Profound, color = "Profound")) +
  geom_line(aes(y = Dead, color = "Dead")) +
  theme_minimal() +
  labs(
    title = "Probabilidades de transición para hombres en estado Able",
    x = "Edad",
    y = "Valor"
  ) +
  scale_color_manual(values = c(
    "Able" = "green",
    "Mild" = "navyblue",
    "Moderate" = "magenta",
    "Severe" = "yellow",
    "Profound" = "cyan",
    "Dead" = "purple"
  ))

fig %>% ggplotly()
```
```{r, echo = FALSE, message=FALSE, warning=FALSE}
fig <- ggplot(Females$Able, aes(x = x)) +
  geom_line(aes(y = Able, color = "Able")) +
  geom_line(aes(y = Mild, color = "Mild")) +
  geom_line(aes(y = Moderate, color = "Moderate")) +
  geom_line(aes(y = Severe, color = "Severe")) +
  geom_line(aes(y = Profound, color = "Profound")) +
  geom_line(aes(y = Dead, color = "Dead")) +
  theme_minimal() +
  labs(
    title = "Probabilidades de transición para mujeres en estado Able",
    x = "Edad",
    y = "Valor"
  ) +
  scale_color_manual(values = c(
    "Able" = "green",
    "Mild" = "navyblue",
    "Moderate" = "magenta",
    "Severe" = "yellow",
    "Profound" = "cyan",
    "Dead" = "purple"
  ))

fig %>% ggplotly()
```

# Mejora de mortalidades en el tiempo y mejora de transiciones de empeoramiento

```{r}
degradar_mort <- function(x, sex){
  if(sex == 1){
    data <- Males
  } else {
    data <- Females
  }
  Able <- data$Able[(x+1):120,]
  Mild <- data$Mild[(x+1):120,]
  Moderate <- data$Moderate[(x+1):120,]
  Severe <- data$Severe[(x+1):120,]
  Profound <- data$Profound[(x+1):120,]
  
  # Constantes a multiplicar
  degr <- sapply(x:119, function(y) red_factor_rest(y, 28 + y - x, 2))
  mort <- sapply(x:119, function(y) red_factor_mort(y, 28 + y - x, 2))
  
  # Mejora las transiciones que empeoran
  Able$Mild <- Able$Mild * degr
  Able$Moderate <- Able$Moderate * degr
  Able$Severe <- Able$Severe * degr
  Able$Profound <- Able$Profound * degr
  Mild$Moderate <- Mild$Moderate * degr
  Mild$Severe <- Mild$Severe * degr
  Mild$Profound <- Mild$Profound * degr
  Moderate$Severe <- Moderate$Severe * degr
  Moderate$Profound <- Moderate$Profound * degr
  Severe$Profound <- Severe$Profound * degr
  
  # Mejora las probabilidades de muerte
  Able$Dead <- Able$Dead * mort
  Mild$Dead <- Mild$Dead * mort
  Moderate$Dead <- Moderate$Dead * mort
  Severe$Dead <- Severe$Dead * mort
  Profound$Dead <- Profound$Dead * mort
  
  # Recalcula las probabilidades de permanecer en el estado
  Able <- Able %>% mutate(Able = 1 -rowSums(select(., -x, -Able)))
  Mild <- Mild %>% mutate(Mild = 1 -rowSums(select(., -x, -Mild)))
  Moderate <- Moderate %>% mutate(Moderate = 1 -rowSums(select(., -x, -Moderate)))
  Severe <- Severe %>% mutate(Severe = 1 -rowSums(select(., -x, -Severe)))
  Profound <- Profound %>% mutate(Profound = 1 -rowSums(select(., -x, -Profound)))
  
  # Devuelve la lista para la edad x
  Tables <- list(Able = Able,
                 Mild = Mild,
                 Moderate = Moderate,
                 Severe = Severe,
                 Profound = Profound)
  return(Tables)
}
```

```{r}
a <- degradar_mort(20, 1)
```


# Diseño del producto
Pago de primas: anual
Esto se justifica con las probabilidades de transición de un año
Temporalidad del seguro: vitalicio
Es un seguro LTC, por lo que esperamos a que el asegurado tenga varios estados
antes de morir. Si no fuera vitalicio, dejaríamos a medias a un asegurado.
Temporalidad de pago de primas: hasta entrar en los estados severe/profound

Inflación: 3%
  Caso pesimista: 8%
  Caso optimista: -1%
  
Tasa de interés: 5%
  Caso pesimista: 3%
  Caso optimista: 6.5%


```{r}
calculo_acumulado <- function(x, tables){
  # Por si acaso, termina en 000001 porque estamos multiplicando todas las transiciones
  t1 <- tables$Able %>% select(-x)
  t2 <- tables$Mild %>% select(-x) 
  t3 <- tables$Moderate %>% select(-x)
  t4 <- tables$Severe %>% select(-x)
  t5 <- tables$Profound %>% select(-x)
  estados <- as.numeric(t1[x+1,])
  suma <- estados
  for(i in (x+2):120){
    matriz_t <- rbind(t1[i,], t2[i,], t3[i,], t4[i,], t5[i,], c(0,0,0,0,0,1)) 
    matriz_t <- as.matrix(matriz_t)
    estados <- estados %*% matriz_t
    suma <- suma + estados
  }
  return(suma)
}
```

```{r}
t <- proc.time()
b <- calculo_acumulado(21, Males)
proc.time() - t 
```




































